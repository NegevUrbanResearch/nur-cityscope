<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>OTEF Interactive Map</title>

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Proj4 for coordinate transformations -->
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>

    <!-- PMTiles for vector tiles -->
    <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>
    <script src="https://unpkg.com/protomaps-leaflet@4.0.0/dist/protomaps-leaflet.js"></script>

    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div id="map"></div>


    <!-- Floating controls -->
    <div id="controls">
      <div id="connectionStatus" class="status-disconnected">‚óè</div>
    </div>

    <!-- Cartographic Legend (bottom right, shows only active layers) -->
    <div id="mapLegend" class="map-legend"></div>

    <!-- Feature info popup (shown on tap) -->
    <div id="featureInfo" class="panel hidden"></div>

    <script src="js/map-utils/coordinate-utils.js"></script>
    <script src="js/map-utils/vector-styling.js"></script>
    <script src="js/map-utils/layer-loader.js"></script>
    <script src="js/map-utils/debug-overlay.js"></script>
    <script src="js/shared/message-protocol.js"></script>
    <script src="js/shared/websocket-shared.js"></script>
    <script src="js/shared/api-client.js"></script>
    <script src="js/shared/OTEFDataContext.js"></script>
    <script src="js/shared/layer-registry.js"></script>
    <script src="js/shared/table-switcher.js"></script>
    <script src="js/shared/table-switcher-popup.js"></script>
    <script src="js/map-utils/style-applicator.js"></script>
    <script src="js/map/map-initialization.js"></script>
    <script src="js/map/leaflet-control-with-basemap.js"></script>
    <script src="js/map/layer-state-manager.js"></script>
    <script src="js/map/map-legend.js"></script>
    <script src="js/map/viewport-sync.js"></script>

    <script>
      // Initialize table switcher
      const tableSwitcher = new TableSwitcher({
        defaultTable: 'otef',
        onTableChange: (tableName) => {
          if (tableName !== 'otef') {
            // Redirect to dashboard for other tables
            window.location.href = `/dashboard/?table=${tableName}`;
          }
        }
      });

      // Make tableSwitcher globally available for layer loading
      window.tableSwitcher = tableSwitcher;

      // Only show OTEF interface if table is 'otef'
      if (tableSwitcher.getCurrentTable() !== 'otef') {
        window.location.href = `/dashboard/?table=${tableSwitcher.getCurrentTable()}`;
      } else {
        // Initialize keyboard-driven table switcher popup
        new TableSwitcherPopup(tableSwitcher);
      }
    </script>
  </body>
</html>
